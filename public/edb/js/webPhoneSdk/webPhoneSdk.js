var server="https://janus-ykf.7moor.com/janus",server_waiwang="https://janus-ykf.7moor.com/janus",networkTestingUrl="https://janusslb.7moor.com/heart",janus=null,sipcall=null,opaqueId="7moorSip-"+Janus.randomString(12),started=!1,spinner=null,selectedApproach="secret",registered=!1,incoming=null,media_server=null,current_jsep=null,current_result=null,reconnect_set_time_out=null,networkTestingInterval=null,m7webPhoneUtils={qhbUrl:"https://webphone.7moor.com",kickSocketUrl:"wss://ccpclient.7moor.com/ws",kickSocket:null,_isKicked:!1,setKickSocket:function(e){m7webPhoneUtils.kickSocket=new WebSocket(m7webPhoneUtils.kickSocketUrl),m7webPhoneUtils.kickSocket.onopen=function(){console.log("Socket has been opened"),console.log('{"flag": "qhb", "user": "'+e+'"}'),m7webPhoneUtils.kickSocket.send('{"flag": "qhb", "user": "'+e+'"}')},m7webPhoneUtils.kickSocket.onmessage=function(e){"kick"===e.data&&(m7webPhoneUtils._isKicked=!0,m7WebPhone.onMessage&&"function"==typeof m7WebPhone.onMessage&&m7WebPhone.onMessage("kicked"))},m7webPhoneUtils.kickSocket.onclose=function(){console.log("Socket has been closed"),m7WebPhone.onError({type:"socket",error:"Socket has been closed"})},m7webPhoneUtils.kickSocket.onerror=function(e){console.log(e),console.log("socket error"),m7WebPhone.onError({type:"socket",error:e})}},sendPostCommand:function(e,o,t,n,i){var s=m7$.toJSON(e.data);e.data=s,console.log("http--send--\x3e"+m7$.toJSON(e)),m7$.ajax({type:"POST",url:m7webPhoneUtils.qhbUrl+"/action",async:n,data:e,timeout:null!=i?i:3e4,dataType:"json",success:function(e,n){"function"==typeof o&&(e.Succeed?o:t)(e)},error:function(e,n,o){t&&"function"==typeof t?t(e,n,o):"success"!=e.statusText&&console.log("请求超时或网络问题,"+n||o)}})},networkTesting:function(){var i=(new Date).getTime();let s;m7webPhoneUtils.sendNetWork&&m7$.ajax({type:"get",url:networkTestingUrl,async:!0,timeout:3e4,dataType:"jsonp",success:function(e,n){var o=(new Date).getTime();"success"===n?(s=(o-i)/2,m7webPhoneUtils.sendNetWork(s)):m7webPhoneUtils.sendNetWork("error")},error:function(e,n,o){var t=(new Date).getTime();200===e.status?(s=(t-i)/2,m7webPhoneUtils.sendNetWork(s)):m7webPhoneUtils.sendNetWork("error")}})}},m7WebPhone={onMessageCallback:null,initCallback:null,onError:null,loginQhbWebPhone:function(e){var n=e.username+"-"+(new Date).getTime(),e={action:"softphone.loginNoCode",data:{loginName:e.username,password:e.pwd,kickToken:n}};m7webPhoneUtils.sendPostCommand(e,function(e){m7webPhoneUtils.setKickSocket(n),console.log("final: media_ip="+e.media_ip+";janus_server="+server+";assDomain="+e.assDomain),media_server=e.media_ip+":"+e.media_port,console.log("sip:"+media_server,"sip:"+e.sip_id+"@"+media_server,e.sip_id,e.sip_pwd,e.sip_id),m7WebPhone.media_server=media_server,m7WebPhone.sip_id=e.sip_id,m7WebPhone.sip_pwd=e.sip_pwd,m7WebPhone.initWebSipPhone("sip:"+media_server,"sip:"+e.sip_id+"@"+media_server,e.sip_id,e.sip_pwd,e.sip_id)},function(e){m7WebPhone.onError(e)}),networkTestingInterval=networkTestingInterval||setInterval(function(){m7webPhoneUtils.networkTesting()},5e3)},initWebSipPhone:function(n,o,t,i,s){Janus.init({debug:!0,callback:function(){started||(started=!0,Janus.isWebrtcSupported()?janus=new Janus({server:server,withCredentials:!0,iceTransportPolicy:"relay",iceServers:[{urls:"stun:116.62.108.217:3478"},{urls:"turn:116.62.108.217:3478",username:"7moor",credential:"7moorpasswd"}],success:function(){janus.attach({plugin:"janus.plugin.sip",opaqueId:opaqueId,success:function(e){sipcall=e,Janus.log("Plugin attached! ("+sipcall.getPlugin()+", id="+sipcall.getId()+")"),selectedApproach="secret",registerUsername(n,o,t,i,s)},error:function(e){m7WebPhone.onError(e)},consentDialog:function(e){Janus.debug("Consent dialog should be "+(e?"on":"off")+" now")},onmessage:function(e,n){current_jsep=n,m7WebPhone.onMessage&&"function"==typeof m7WebPhone.onMessage&&(o="incomingcall"===e.result.event?"asterisk"===e.result.displayname.replace(/"/g,"")?"Outbound":"incomingcall":e.result.event,m7WebPhone.onMessage(o)),Janus.debug(" ::: Got a message :::"),Janus.debug(e);var o=e.error;if(null!=o&&null!=o)return registered&&sipcall.hangup(),void alert(o);var t,i,o=e.result;null!=(current_result=o)&&void 0!==o.event&&null!==o.event&&("registration_failed"!==(e=o.event)?"registered"===e?(Janus.log("Successfully registered as "+o.username+"!"),registered=registered||!0):"calling"===e?Janus.log("Waiting for the peer to answer..."):"incomingcall"===e?(incoming=!0,Janus.log("Incoming call from "+o.username+"!"),"asterisk"===o.displayname.replace(/"/g,"")&&window.setTimeout(function(){m7WebPhone.AnswerCall()},300),t=window.Notification||window.mozNotification||window.webkitNotification,(i=document.getElementById("ringing-tone"))&&i.play(),t?t.requestPermission(function(e){var n;"granted"!=e||(Math.random(),(n=new t("来电通知",{dir:"auto",lang:"",tag:"来电通知",renotify:!0,body:"callerNum"})).onclick=function(){window.focus()},n.onerror=function(e){console.log(e),console.log("HTML5桌面消息出错！！！")},n.onshow=function(){setTimeout(function(){n.close()},1e4)},n.onclose=function(){console.log("HTML5桌面消息关闭！！！")})}):console.log("您的浏览器不支持桌面消息")):"accepting"===e||("progress"===e?(Janus.log("There's early media from "+o.username+", wairing for the call!"),Janus.log(n),null!=n&&sipcall.handleRemoteJsep({jsep:n,error:doHangup}),toastr.info("Early media...")):"accepted"===e?((i=document.getElementById("ringing-tone"))&&i.pause(),Janus.log(o.username+" accepted the call!"),Janus.log(n),null!=n&&sipcall.handleRemoteJsep({jsep:n,error:doHangup})):"hangup"===e&&((i=document.getElementById("ringing-tone"))&&i.pause(),null!=incoming&&(incoming.modal("hide"),incoming=null),Janus.log("Call hung up ("+o.code+" "+o.reason+")!"),sipcall.hangup())):Janus.warn("Registration failed: "+o.code+" "+o.reason))},onlocalstream:function(e){Janus.debug(" ::: Got a local stream :::"),Janus.debug(e),0===m7$("#myvideo").length&&m7$("body").append('<video class="rounded centered" id="myvideo" width=320 height=240 autoplay muted="muted"/>'),Janus.attachMediaStream(m7$("#myvideo").get(0),e),m7$("#myvideo").get(0).muted="muted",m7$("body").append('<video class="rounded centered" id="waitingvideo" width=320 height=240 />');e.getVideoTracks()},onremotestream:function(e){Janus.debug(" ::: Got a remote stream :::"),Janus.debug(e),m7$("body").append('<video class="rounded centered hide" id="remotevideo" width=320 height=240 autoplay />'),Janus.attachMediaStream(m7$("#remotevideo").get(0),e)},oncleanup:function(){Janus.log(" ::: Got a cleanup notification :::")}})},error:function(e){Janus.error(e),m7WebPhone.onError("JanusError:"+e),("Lost connection to the gateway (is it down?)"===e||e&&-1!==e.indexOf("Probably a network error, is the gateway down?")&&window.userLogin)&&(started=!1,reconnect_set_time_out&&clearTimeout(reconnect_set_time_out),reconnect_set_time_out=setTimeout(function(){m7WebPhone.initWebSipPhone("sip:"+m7WebPhone.media_server,"sip:"+m7WebPhone.sip_id+"@"+m7WebPhone.media_server,m7WebPhone.sip_id,m7WebPhone.sip_pwd,m7WebPhone.sip_id)},2e3))},destroyed:function(){m7WebPhone.onError("JanusError: destroyed")}}):alert("No WebRTC support... "))}})},AnswerCall:function(){var n,o,e,t;!0===incoming&&null!==current_jsep&&null!==current_result&&(e=!(o=n=!0),null!=current_jsep?(n=-1<current_jsep.sdp.indexOf("m=audio "),o=-1<current_jsep.sdp.indexOf("m=video "),Janus.debug("Audio "+(n?"has":"has NOT")+" been negotiated"),Janus.debug("Video "+(o?"has":"has NOT")+" been negotiated")):(Janus.log("This call doesn't contain an offer... we'll need to provide one ourselves"),o=!(e=!0)),t=current_result.srtp),incoming=null,(e?sipcall.createOffer:sipcall.createAnswer)({jsep:current_jsep,media:{audio:n,video:o},success:function(e){Janus.debug("Got SDP "+e.type+"! audio="+n+", video="+o),Janus.debug(e);sipcall.send({message:{request:"accept"},jsep:e})},error:function(e){Janus.error("WebRTC error:",e),-1<e.indexOf("capture")?e="未检测到接听设备，请检查对应设备是否正常，如耳机。":-1<e.indexOf("DTMF")?e="按键错误！":e.indexOf("gateway")?e="服务异常！":e.indexOf("Unknown error")?e="未知错误！":e.indexOf("HTTPS")&&(e="环境错误，请使用https环境"),alert("WebRTC error... "+JSON.stringify(e));sipcall.send({message:{request:"decline",code:480}})}})}};function initM7WebPhone(e){this.init(e)}function registerUsername(e,n,o,t,i){n={request:"register",username:n};n.authuser=o,n.display_name=i,n.secret=t,n.proxy=e,sipcall.send({message:n})}function doHangup(){m7$("#call").attr("disabled",!0).unbind("click");sipcall.send({message:{request:"hangup"}}),sipcall.hangup()}function getUserMedia(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}initM7WebPhone.prototype.onMessage=function(e){m7WebPhone.onMessage=e},initM7WebPhone.prototype.onError=function(e){m7WebPhone.onError=e,getUserMedia()||m7WebPhone.onError("No capture device found")},initM7WebPhone.prototype.init=function(e){janus&&(started=!1,janus.destroy()),m7WebPhone.loginQhbWebPhone(e)},initM7WebPhone.prototype.destroy=function(e){janus&&(started=!1,janus.destroy())},initM7WebPhone.prototype.networkMonitoring=function(e){m7webPhoneUtils.sendNetWork=e},initM7WebPhone.prototype.sendDTMF=function(e){sipcall&&sipcall.send({message:{request:"dtmf_info",digit:e}})},initM7WebPhone.prototype.Outbound=function(){sipcall?sipcall.createOffer({jsep:current_jsep,media:{video:!1,audio:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}},success:function(e){sipcall.send({message:{request:"accept"},jsep:e})},error:function(e){m7WebPhone.onError(e)}}):m7WebPhone.onError("初始化失败")},initM7WebPhone.prototype.dialout=function(e){var o;e&&media_server&&sipcall&&(o="sip:"+e+"@"+media_server,sipcall.createOffer({media:{videoSend:!1,videoRecv:!1,audio:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}},success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);var n={request:"call",uri:o};sipcall.send({message:n,jsep:e})},error:function(e){Janus.error("WebRTC error...",e),alert("WebRTC error... "+JSON.stringify(e))}}))},initM7WebPhone.prototype.toggleMute=function(){var e=sipcall.isAudioMuted();Janus.log((e?"Unmuting":"Muting")+" local stream..."),e?sipcall.unmuteAudio():sipcall.muteAudio(),sipcall.isAudioMuted()};