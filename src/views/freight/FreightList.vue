<template>
  <div
    v-loading="listLoading"
    :class="isPC ? 'FreightList' : 'FreightList-m'"
  >
    <FreightListForm
      :tab="tab"
      :dispatch="dispatchTab"
      :list-query="listQuery"
      :date-value="DateValue"
      :date-value2="DateValue2"
      @handle-tags="handleTags"
      @handle-check="handleCheck"
      @handle-query="getList"
    />
    <div class="table_box">
      <!--table表单-->
      <div class="table-title">
        筛选结果（<span>{{ tableTitle.all }}</span>条）：
        司机侧已上报<span>{{ tableTitle.gmStatusCount }}</span>条，<span>{{ tableTitle.gmStatusSum }}</span>元；
        客户侧已上报<span>{{ tableTitle.lineStatusCount }}</span>条，<span>{{ tableTitle.lineStatusSum }}</span>元；
        单边或交叉已确认<span>{{ tableTitle.crossCheckCount }}</span>条，<span>{{ tableTitle.crossCheckSum }}</span>元
      </div>
      <div
        class="table_center"
        :style="total > 0 ? '' : 'padding-bottom: 30px;'"
      >
        <el-table
          ref="multipleTable"
          :data="list"
          :row-style="{height: '20px'}"
          :cell-style="{padding: '5px 0'}"
          size="mini"
          :max-height="tableHeight"
          fit
          :border="isPC"
          stripe
          highlight-current-row
          style="width: 100%"
          row-key="wayBillId"
          @selection-change="handleSelectionChange"
        >
          <el-table-column
            fixed
            reserve-selection
            type="selection"
            width="55"
            :selectable="selectable"
          />
          <el-table-column
            type="index"
            width="55"
            label="序号"
            :index="indexMethod('listQuery')"
            align="center"
          />
          <el-table-column
            align="left"
            label="出车日期"
            min-width="100"
          >
            <template slot-scope="scope">
              <span>{{ scope.row.departureDate | TimestampYMD }}</span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="出车单号"
            min-width="140"
          >
            <template slot-scope="scope">
              <el-link
                type="primary"
                style="font-size: 12px;"
                @click="goDetail(scope.row.wayBillId)"
              >
                {{ scope.row.wayBillId | DataIsNull }}
              </el-link>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="司机姓名"
            min-width="145"
          >
            <template slot-scope="scope">
              <span>{{ scope.row.driverName + '/' + scope.row.driverPhone | DataIsNull }}</span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="线路名称"
            min-width="150"
          >
            <template slot-scope="{row}">
              {{ row.lineName + '/' + row.lineId | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="客户名称"
            min-width="100"
          >
            <template slot-scope="{row}">
              {{ row.customerClueName | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="项目名称"
            min-width="100"
          >
            <template slot-scope="{row}">
              {{ row.projectName | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="出车状态"
          >
            <template slot-scope="{row}">
              {{ row.departStatus | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="运费金额（元）"
            min-width="110"
          >
            <template slot-scope="{row}">
              <span v-if="row.departStatusCode === 1">未出车</span>
              <template v-else>
                <template v-if="row.flag">
                  <el-popover
                    placement="right"
                    trigger="hover"
                    @show="getFloowData(row.wayBillId, 'confirm')"
                  >
                    <el-table

                      v-loading="floowLoading"
                      :data="floowData"
                      size="mini"
                    >
                      <el-table-column
                        type="index"
                        width="55"
                        label="趟数"
                        align="center"
                      />
                      <el-table-column
                        width="150"
                        property="deliverTime"
                        label="时间段"
                      />
                      <el-table-column
                        width="100"
                        property="money"
                        label="运费"
                      />
                    </el-table>
                    <el-button
                      slot="reference"
                      type="text"
                    >
                      <span v-if="row.status === 20 && row.departStatusCode !== 1">{{ Number(row.freightFee).toFixed(2) | DataIsNull }}</span>
                      <span v-if="row.status !== 20 && row.isLookFee === 1">{{ Number(row.freightFee).toFixed(2) | DataIsNull }}</span>
                    </el-button>
                  </el-popover>
                </template>
                <template v-else>
                  <div @mouseover="handleHoverChange(row)">
                    <span v-if="row.status === 20 && row.departStatusCode !== 1">{{ Number(row.freightFee).toFixed(2) | DataIsNull }}</span>
                    <span v-else-if="row.status !== 20 && row.isLookFee === 1">{{ Number(row.freightFee).toFixed(2) | DataIsNull }}</span>
                  </div>
                </template>
              </template>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="运费状态"
            min-width="105"
          >
            <template slot-scope="{row}">
              <span v-if="row.status !== 5">
                {{ row.statusName | DataIsNull }}
              </span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="预估运费(元)"
            min-width="100"
          >
            <template slot-scope="scope">
              <p>{{ Number(scope.row.predictCost).toFixed(2) | DataIsNull }}</p>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="司机运费上报状态"
            min-width="130"
          >
            <template slot-scope="{row}">
              {{ row.driverFreightFeeUpStatus | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="司机运费上报金额（元）"
            min-width="155"
          >
            <template slot-scope="scope">
              <template v-if="scope.row.gmStatusCode !== 2">
                <template v-if="scope.row.flag">
                  <el-popover
                    v-if="scope.row.gmStatusCode !== 2"
                    placement="right"
                    trigger="hover"
                    @show="getFloowData(scope.row.wayBillId, 'driver')"
                  >
                    <el-table
                      v-loading="floowLoading"
                      :data="floowData"
                      size="mini"
                    >
                      <el-table-column
                        type="index"
                        width="55"
                        label="趟数"
                        align="center"
                      />
                      <el-table-column
                        width="150"
                        property="deliverTime"
                        label="时间段"
                      />
                      <el-table-column
                        width="100"
                        property="money"
                        label="运费"
                      />
                    </el-table>
                    <el-button
                      slot="reference"
                      type="text"
                    >
                      <span v-if="scope.row.gmStatusCode === 1">{{ Number(scope.row.gmFee).toFixed(2) | DataIsNull }}</span>
                    </el-button>
                  </el-popover>
                </template>
                <template v-else-if="scope.row.gmStatusCode === 1">
                  <div @mouseover="handleHoverChange(scope.row)">
                    {{ Number(scope.row.gmFee).toFixed(2) | DataIsNull }}
                  </div>
                </template>
              </template>
              <span v-else>未出车</span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="客户运费上报状态"
            min-width="120"
          >
            <template slot-scope="{row}">
              {{ row.customerFreightFeeUpStatus | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="客户运费上报金额（元）"
            min-width="160"
          >
            <template slot-scope="scope">
              <template v-if="scope.row.lineStatusCode !== 2">
                <template v-if="scope.row.flag">
                  <el-popover
                    v-if="scope.row.lineStatusCode !== 2"
                    placement="right"
                    trigger="hover"
                    @show="getFloowData(scope.row.wayBillId, 'line')"
                  >
                    <el-table
                      v-loading="floowLoading"
                      :data="floowData"
                      size="mini"
                    >
                      <el-table-column
                        type="index"
                        width="55"
                        label="趟数"
                        align="center"
                      />
                      <el-table-column
                        width="150"
                        property="deliverTime"
                        label="时间段"
                      />
                      <el-table-column
                        width="100"
                        property="money"
                        label="运费"
                      />
                    </el-table>
                    <el-button
                      slot="reference"
                      type="text"
                    >
                      <span v-if="scope.row.lineStatusCode === 1">{{ Number(scope.row.lineFee).toFixed(2) | DataIsNull }}</span>
                    </el-button>
                  </el-popover>
                </template>
                <template v-else-if="scope.row.lineStatusCode === 1">
                  <div @mouseover="handleHoverChange(scope.row)">
                    {{ Number(scope.row.lineFee).toFixed(2) | DataIsNull }}
                  </div>
                </template>
              </template>
              <span v-else>未出车</span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="有无差额（元）"
            min-width="120"
          >
            <template slot-scope="{row}">
              {{ Number(row.feeDiffValue).toFixed(2) || 0 }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="加盟经理"
            min-width="150"
          >
            <template slot-scope="{row}">
              {{ row.joinManagerName + '/' + row.joinManagerPhone | DataIsNull }}
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="上岗经理"
            min-width="170"
          >
            <template slot-scope="{row}">
              <span>{{ row.dutyManagerName && row.dutyManagerPhone ? row.dutyManagerName+ '/' +row.dutyManagerPhone:'' }}</span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="运费更新时间"
            min-width="160"
          >
            <template slot-scope="scope">
              <span>{{ scope.row.freightUpdate | Timestamp }}</span>
            </template>
          </el-table-column>
          <el-table-column
            align="left"
            label="单边已确认操作人"
            min-width="160"
          >
            <template slot-scope="scope">
              <span>{{ scope.row.confirmName }}</span>
            </template>
          </el-table-column>

          <el-table-column
            align="left"
            label="操作"
            fixed="right"
            show-overflow-tooltip
            :width="isPC ? 'auto' : '50'"
          >
            <template slot-scope="scope">
              <el-dropdown :trigger="isPC ? 'hover' : 'click'">
                <span
                  v-if="isPC"
                  class="el-dropdown-link"
                >
                  更多操作<i
                    v-if="isPC"
                    class="el-icon-arrow-down el-icon--right"
                  />
                </span>
                <span
                  v-else
                  style="font-size: 18px;"
                  class="el-dropdown-link"
                >
                  <i class="el-icon-setting el-icon--right" />
                </span>
                <el-dropdown-menu slot="dropdown">
                  <!--
                    v-if="scope.row.canConfirm"
                  > -->
                  <el-dropdown-item
                    v-permission="['/v2/waybill/shipping/reportMoneyBatch']"
                    name="ownerlist_detail_dropdown"
                    @click.native="checkOption(scope.row.departureDate, scope.row.wayBillId)"
                  >
                    <!-- {{ scope.row.status === 10 ? '单边确认' : '交叉确认' }} -->
                    <div v-if="scope.row.status === 10">
                      <span
                        v-permission="['/v2/waybill/shipping/reportMoneyBatch']"
                      >单边确认</span>
                    </div>
                    <div v-if="scope.row.status === 30">
                      <span
                        v-permission="['/v2/waybill/shipping/reportMoneyBatch']"
                      >交叉确认</span>
                    </div>
                  </el-dropdown-item>
                  <el-dropdown-item
                    v-permission="['/v2/waybill/shipping/shippingDetail']"
                    name="ownerlist_detail_dropdown"
                    @click.native="goDetail(scope.row.wayBillId)"
                  >
                    详情
                  </el-dropdown-item>
                  <!-- <el-dropdown-item
                    name="ownerlist_edit_dropdown"
                    @click.native="goLog(scope.row.wayBillId)"
                  >
                    日志
                  </el-dropdown-item> -->
                </el-dropdown-menu>
              </el-dropdown>
            </template>
          </el-table-column>
        </el-table>
      </div>
      <pagination
        v-show="total > 0"
        :operation-list="operationList | isPermission"
        :small="true"
        :total="total"
        :page.sync="listQuery.page"
        :limit.sync="listQuery.limit"
        @pagination="getList"
        @olclick="olClicks"
      />
    </div>
    <PitchBox
      :drawer.sync="drawer"
      :drawer-list="multipleSelection"
      @deletDrawerList="deletDrawerList"
      @changeDrawer="changeDrawer"
    >
      <template slot-scope="slotProp">
        <span>{{ slotProp.item.bussinessName }}</span>
        <span>{{ slotProp.item.bussinessPhone }}</span>
        <span>{{ slotProp.item.cityName }}</span>
      </template>
    </PitchBox>

    <!-- 运费确认 -->
    <SelfDialog
      v-if="assignShowDialogMin"
      :visible.sync="assignShowDialogMin"
      :title="`运费确认`"
      :confirm-button-text="`确认`"
      :cancel-button-text="`取消`"
      :other-button-text="`未出车`"
      :show-other-button="true"
      :confirm="confirmAssignMin"
      :other="confirmAssignOtherMin"
      other-type="danger"
    >
      <DetailItem
        name="出车日期"
        :value="formatDate(new Date(freightForm.list[0].departureDate))"
      />
      <DetailItem
        name="出车单号"
        :value="freightForm.list[0].wayBillId+'/'+freightForm.list[0].lineName"
      />
      <DetailItem
        name="司机姓名/手机号"
        :value="freightForm.list[0].driverName + '/' + freightForm.list[0].driverPhone"
      />
      <el-form
        ref="freightForm"
        :model="freightForm"
      >
        <div
          v-for="(item, index) in freightForm.list"
          :key="index"
        >
          <el-form-item
            :label="`趟数` + (index + 1) + `: ` + item.deliverTime"
            :prop="'list[' + index + '].preMoney'"
            :rules="{required: true, message: '请输入金额', trigger: 'change'}"
          >
            <el-input
              v-model="item.preMoney"
              v-only-number="{min: 0, max: 999999.99, precision: 2}"
              placeholder="请输入"
              name="freight_price_input"
              maxlength="10"
              clearable
            />
          </el-form-item>
          <div
            style="color:#FF5D5D"
            class="slot-info"
          >
            <span>{{ renderRefund(item) }}</span>
          </div>
        </div>
        <el-form-item
          label="备注"
          prop="remark"
        >
          <el-input
            v-model="freightForm.remark"
            name="addclue_remark_input"
            type="textarea"
            :autosize="{minRows: 2, maxRows: 4}"
            placeholder="请输入"
            maxlength="100"
            clearable
          />
        </el-form-item>
      </el-form>
    </SelfDialog>

    <!-- 批量运费确认 -->
    <SelfDialog
      v-if="assignShowDialog"
      :visible.sync="assignShowDialog"
      :title="`批量运费确认`"
      :confirm-button-text="`全部提交`"
      :cancel-button-text="`取消`"
      :other-button-text="`全部未出车`"
      :show-other-button="true"
      :confirm="confirmAssign"
      :other="confirmAssignOther"
      other-type="danger"
    >
      <el-form
        ref="freightFormAll"
        :model="freightFormAll"
      >
        <el-alert
          class="mb10"
          :title="`已选中${multipleSelection.length}条出车单`"
          type="warning"
          :closable="false"
        />
        <div
          v-for="(item, itemindex) in freightFormAll.lists"
          :key="item.id"
          class="freightSelfDialog"
        >
          <div style="box-sizing:border-box;">
            <el-row>
              <el-col :span="12">
                <el-switch
                  v-model="item.check"
                  style="padding:25px 15px;display: block"
                  active-color="#13ce66"
                  inactive-color="#F56C6C"
                  active-text="已出车"
                  inactive-text="未出车"
                />
              </el-col>
              <el-col :span="12">
                <div
                  class="DetailItem"
                  style="margin-top: 20px;"
                >
                  <span class="detail-title">出车日期</span>
                  <span class="detail-value">{{ formatDate(new Date(item.departureDate)) }}</span>
                </div>
              </el-col>
            </el-row>
          </div>
          <DetailItem
            name="出车单号/线路名称"
            :value="item.wayBillId+'/'+item.lineName"
          />
          <DetailItem
            name="司机姓名/手机号"
            :value="item.driverName + '/' + item.driverPhone"
          />
          <div
            v-if="item.check"
          >
            <div
              v-for="(i, index) in item.list"
              :key="index"
            >
              <el-form-item
                :label="`趟数` + (index + 1) + `: ` + i.deliverTime"
                :prop="'lists[' + itemindex + '].list.' + index + '.preMoney'"
                :rules="{required: true, message: '请输入金额', trigger: 'change'}"
              >
                <el-input
                  v-model="i.preMoney"
                  v-only-number="{min: 0, max: 999999.99, precision: 2}"
                  placeholder="请输入"
                  name="freight_price_input"
                  maxlength="10"
                  type="number"
                  clearable
                />
              </el-form-item>

              <div
                style="color:#FF5D5D"
                class="slot-info"
              >
                <span>{{ renderRefund(i) }}</span>
              </div>
            </div>
          </div>
        </div>
        <el-form-item
          label="备注"
          prop="remark"
        >
          <el-input
            v-model="remarkAll"
            name="addclue_remark_input"
            type="textarea"
            :autosize="{minRows: 2, maxRows: 4}"
            placeholder="请输入"
            maxlength="100"
            clearable
          />
        </el-form-item>
      </el-form>
    </SelfDialog>
    <!--提示窗口-->
    <SelfDialog
      :visible.sync="showDialog.visible"
      :title="showDialog.title"
      :center="true"
      :confirm="confirm"
    >
      <p>{{ showDialog.text }}</p>
    </SelfDialog>
  </div>
</template>

<script lang="ts">
import { Component, Vue, Watch } from 'vue-property-decorator'
// import { Form as ElForm, Input } from 'element-ui'
import { GetConfirmInfoList, ReportMoneyBatch, WayBillAmountDetail, NoCarBatch, freightTripMoney } from '@/api/freight'
// import { GetFindBusinessPhone } from '@/api/cargo'
import { CargoListData } from '@/api/types'
import { HandlePages, lock } from '@/utils/index'
import Pagination from '@/components/Pagination/index.vue'
import TableHeader from '@/components/TableHeader/index.vue'
import SuggestContainer from '@/components/SuggestContainer/index.vue'
import SelfDialog from '@/components/SelfDialog/index.vue'
import SelfTable from '@/components/Base/SelfTable.vue'
import PitchBox from '@/components/PitchBox/index.vue'
import { FreightListForm } from './components'
import DetailItem from '@/components/DetailItem/index.vue'
import { SettingsModule } from '@/store/modules/settings'
import '@/styles/common.scss'
// import RenderRefund from './components/renderRefund.js'
// import {parseTime} from '@/utils/index'

interface IState {
  [key: string]: any;
}
@Component({
  name: 'FreightList',
  components: {
    Pagination,
    SuggestContainer,
    TableHeader,
    FreightListForm,
    SelfDialog,
    SelfTable,
    DetailItem,
    PitchBox
  }
})
export default class extends Vue {
    private showDialog: any = {
      visible: false,
      title: '提示',
      text: '内容',
      name: ''
    };
    private drawer: boolean= false;
    private total = 0;
    private list: CargoListData[] = [];
    private page: Object | undefined = '';
    private listLoading = true;
    private tags: any[] = [];
    // private templateRadio: any[] = [] // TODO
    private DateValue: any[] = [];
    private DateValue2: any[] = [];
    private multipleSelection: any[] = []
    private operationList: any[] = [
      { icon: 'el-icon-finished', name: '运费确认', color: '#F2A33A', key: '3', pUrl: ['/v2/waybill/shipping/reportMoneyBatch'] },
      { icon: 'el-icon-circle-close', name: '清空选择', color: '#F56C6C', key: '2' }
    ];
    private floowData: any[] = [];
    private floowLoading: Boolean = false;
    private tab: any[] = [
      {
        label: '全部',
        name: '',
        num: ''
      },
      // {
      //   label: '待上报',
      //   name: '5',
      //   num: ''
      // },
      {
        label: '待单边确认',
        name: '10',
        num: ''
      },
      {
        label: '单边已确认',
        name: '20',
        num: ''
      },
      {
        label: '待交叉确认',
        name: '30',
        num: ''
      },
      {
        label: '已交叉确认',
        name: '40',
        num: ''
      }
    ];
    private dispatchTab: any[] = [
      {
        label: '全部',
        name: '',
        num: ''
      },
      {
        label: '待出车',
        name: '0',
        num: ''
      },
      {
        label: '已出车',
        name: '2',
        num: ''
      },
      {
        label: '未出车',
        name: '1',
        num: ''
      }
    ];
    private listQuery: IState = {
      customer: '',
      customerCity: '',
      customerName: '',
      productName: '',
      driver: '',
      driverCity: '',
      dutyManagerId: '',
      page: 1,
      limit: 30,
      startDate: '',
      endDate: '',
      freightStartTime: '',
      freightEndTime: '',
      feeDiff: '',
      gmId: '',
      key: '',
      line: '',
      pageNumber: '',
      project: '',
      wayBillId: '',
      state: '',
      dispatchState: '',
      business: '',
      clientUpLoadState: '',
      driverUpLoadState: '',
      lineSaleId: ''
    };
    private freightForm: any = {
      list: [
        {
          price: ''
        },
        {
          price: ''
        }
      ],
      remark: ''
    };
    private freightFormAll: any = { lists: [
      {
        list: [
          {
            price: ''
          },
          {
            price: ''
          }
        ]
      }
    ] }
    // private freightRules: any = {
    //   price: [
    //     { required: true, message: '请输入金额', trigger: 'change' }
    //   ]
    // };
    private saleId: any = '';
    private remarkAll: any = '';
    // 弹窗分配
    private dialogList: any[] = [];
    // private dialogLoading: boolean= false;
    // private multipleSelectionAssign: any[] = []
    private assignShowDialog: boolean= false;
    private assignShowDialogMin: boolean= false;
    // 弹窗分页
    // private dialogTotal: number = 0;
    private dialogListQuery: IState = {
      page: 1,
      limit: 20
    };
    private delay: number = 1000;

    // private getPermission(role: any) {
    //   let permission = (localStorage as any).getItem('permission')
    //   if (!permission) {
    //     return false
    //   } else {
    //     let permissionArr = permission.split(',')
    //     if (permissionArr.indexOf(role) > -1) {
    //       return true
    //     } else {
    //       return false
    //     }
    //   }
    // }

    // 判断是否是PC
    get isPC() {
      return SettingsModule.isPC
    }

    // table列表高度适配
    get tableHeight() {
      return 'auto'
    }
    // 确认清除
    private confirm(done:any) {
      if (this.showDialog.name === '1') {
        (this.$refs.multipleTable as any).clearSelection()
        this.multipleSelection = []
      } else {
        this.assignShowDialog = true
      }
      done()
    }

    // 判断是否可以选中
    private selectable(row: any) {
      if (row.status === 5 || row.status === 40 || row.status === 20) {
        return false
      }
      // return row.canConfirm
      return true
    }

    // 所有请求方法
    private fetchData() {
      this.listQuery.state = this.$route.params.state || ''
      this.getList(this.listQuery)
    }

    // 处理tags方法
    private handleTags(value: any) {
      this.tags = value
    }

    // 处理check方法
    private handleCheck() {
      (this.$refs.multipleTable as any).clearSelection()
    }

    handleHoverChange(row:IState) {
      row.flag = true
    }

    // 处理选择日期方法
    // private handleDate(value: any, name: any) {
    //   if (name === 'startDate') {
    //     this.DateValue = value
    //   } else {
    //     this.DateValue2 = value
    //   }
    // }
    private renderRefund(item:any) {
      let shipping = ''
      let driverFreight = ''
      let customerFreight = ''
      let statusName = ''
      const { status, confirmFee, gmIsNoCar,
        gmcFee, gmFee, gmStatus, gmStatusName,
        lineStatus, lineStatusName, lineFee,
        gmcIsNoCar
      } = item
      if (status === 30) {
        if (gmcIsNoCar) {
          shipping = '未出车'
          driverFreight = '未出车'
          statusName = '（已单边确认）'
        } else {
          if (!confirmFee && typeof confirmFee !== 'number') {
            if (gmIsNoCar) {
              shipping = ''
              driverFreight = (gmStatusName || 0 + '元')
            } else {
              shipping = ''
              driverFreight = (gmFee || 0) + '元'
            }
          } else {
            shipping = (gmcFee || 0) + '元'
            driverFreight = (gmcFee || 0) + '元'
            statusName = '（已单边确认）'
          }
        }
        customerFreight = lineStatus === 2 ? lineStatusName : lineFee + '元'
        return `运费金额${statusName}：${shipping}；
              司机侧：${driverFreight}；
              客户侧：${customerFreight}；
              `
      } else if (status === 10 && gmStatus === 2) {
        return '加盟侧：未出车'
      }
      return ''
    }
    // 处理是否展示运费确认的总按钮
    private handleChecked(arr: any) {
      let list = [
        { icon: 'el-icon-finished', name: '运费确认', color: '#F2A33A', key: '3', pUrl: ['/v2/waybill/shipping/reportMoneyBatch'] },
        { icon: 'el-icon-circle-close', name: '清空选择', color: '#F56C6C', key: '2' }
      ]
      for (let i = 0; i < arr.length; i++) {
        if (arr[i].status === 10 || arr[i].status === 30) {
          this.operationList = list
          return true
        }
      }
      list.shift()
      this.operationList = list
    }
    private tableTitle = {
      all: '',
      gmStatusCount: '',
      gmStatusSum: '',
      lineStatusCount: '',
      lineStatusSum: '',
      crossCheckCount: '',
      crossCheckSum: ''
    }
    private async getList(this:any, value: any) {
      this.list = []
      this.listQuery.page = value.page
      this.listQuery.limit = value.limit
      this.listLoading = true
      console.time('time')
      const { data } = await GetConfirmInfoList(this.listQuery) // 获取列表
      this.listLoading = false
      console.timeEnd('time')
      if (data.success) {
        // this.$refs['multipleTable'].clearSelection()
        this.list = data.data.map((item:IState) => {
          item.flag = false
          return item
        })
        this.tableTitle = data.title
        this.handleChecked(data.data)
        data.page = await HandlePages(data.page)
        this.total = data.page.total
      } else {
        this.$message.error(data)
        this.listLoading = false
      }
    }

    // 确认操作
    private async checkOption(time: any, id: any) {
      // let type = this.getWeekStartDate(time)
      let type = false
      if (type) {
        let endTime = this.getWednesdayDate(time)
        this.$alert('出车单可确认时间，为' + endTime, '提示', {
          confirmButtonText: '确定',
          callback: action => {
          }
        })
      } else {
        const { data } = await WayBillAmountDetail([id]) // 批量上报、运费回显
        if (data.success) {
          this.freightForm.list = data.data
          this.assignShowDialogMin = true
          this.freightForm.remark = ''
        } else {
          this.$message.error(data.errorMsg)
        }
      }
    }

    // 按钮操作
    private goDetail(id: string | (string | null)[] | null | undefined) {
      let purl: any = localStorage.getItem('permission')
      if (purl) {
        let purlArr: any = purl.split(',')
        if (purlArr.indexOf('/v2/waybill/shipping/shippingDetail') < 0) {
          return
        }
      }
      this.$router.push({ name: 'FreightDetail', query: { id: id } })
    }

    // 跳转线索
    private goLog(id: string | (string | null)[] | null | undefined) {
      this.$router.push({ name: 'FreightLog', query: { id: id } })
    }

    // 批量操作
    private async olClicks(item: any) {
      if (item.key === '2') {
        if (this.multipleSelection.length) {
          this.showDialog = {
            visible: true,
            title: '清空确认',
            text: '确认清空所有选择吗？',
            name: '1'
          }
        } else {
          this.$message({
            type: 'warning',
            message: '请先选择出车单'
          })
        }
      } else if (item.key === '3') {
        if (this.multipleSelection.length) {
          let ids: any = []
          this.multipleSelection.forEach((i: any) => {
            ids.push(i.wayBillId)
          })
          const { data } = await WayBillAmountDetail(ids) // 批量上报、运费回显
          if (data.success) {
            let ret: any = []
            let list: any = []
            let datas = data.data
            datas.forEach((i: any, index: any) => {
              // this.freightForm[index].list = i
              if (ret.indexOf(i.wayBillId) === -1) {
                ret.push(i.wayBillId)
                i.check = true
                i.list = []
                let lists = Object.assign({}, i)
                lists.list.push({
                  deliverTime: lists.deliverTime,
                  wayBillId: lists.wayBillId,
                  wayBillAmountId: lists.wayBillAmountId,
                  check: lists.check,
                  preMoney: lists.preMoney,
                  status: lists.status,
                  gmIsNoCar: lists.gmIsNoCar,
                  confirmFee: lists.confirmFee,
                  gmStatus: lists.gmStatus,
                  gmStatusName: lists.gmStatusName,
                  gmFee: lists.gmFee,
                  gmcFee: lists.gmcFee,
                  lineStatus: lists.lineStatus,
                  lineStatusName: lists.lineStatusName,
                  lineFee: lists.lineFee,
                  gmcIsNoCar: lists.gmcIsNoCar
                })
                list.push(lists)
              } else {
                list.forEach((e: any) => {
                  if (e.wayBillId === i.wayBillId) {
                    i.check = true
                    let lists = Object.assign({}, i)
                    e.list.push({
                      deliverTime: lists.deliverTime,
                      wayBillId: lists.wayBillId,
                      wayBillAmountId: lists.wayBillAmountId,
                      check: lists.check,
                      preMoney: lists.preMoney,
                      status: lists.status,
                      gmIsNoCar: lists.gmIsNoCar,
                      confirmFee: lists.confirmFee,
                      gmStatus: lists.gmStatus,
                      gmStatusName: lists.gmStatusName,
                      gmFee: lists.gmFee,
                      gmcFee: lists.gmcFee,
                      lineStatus: lists.lineStatus,
                      lineStatusName: lists.lineStatusName,
                      lineFee: lists.lineFee,
                      gmcIsNoCar: lists.gmcIsNoCar
                    })
                  }
                })
              }
            })
            this.freightFormAll.lists = list
            this.assignShowDialog = true
          } else {
            this.$message.error(data.errorMsg)
          }
        } else {
          this.$message({
            type: 'warning',
            message: '请先选择出车单'
          })
        }
      }
    }

    // table选择框
    private handleSelectionChange(val: any) {
      this.multipleSelection = val
    }

    // 关闭查看已选
    private changeDrawer(val: any) {
      this.drawer = val
    }

    // 删除选中项目
    private deletDrawerList(item:any, i:any) {
      (this.$refs.multipleTable as any).toggleRowSelection(item)
    }

    // 弹窗操作
    private async confirmAssignMin(done: any) {
      (this.$refs.freightForm as any).validate(async(valid: boolean) => {
        if (valid) {
          await this.saveData()
          done()
        }
      })
    }
    @lock
    async saveData() {
      try {
        let moneysArr: any = []
        let wayBillAmountIdsArr: any = []
        this.freightForm.list.forEach((i: any) => {
          moneysArr.push(i.preMoney)
          wayBillAmountIdsArr.push(i.wayBillAmountId)
        })
        // 上报出车金额
        const { data } = await ReportMoneyBatch({
          moneys: moneysArr,
          wayBillAmountIds: wayBillAmountIdsArr
        }, this.freightForm.remark)
        if (data.success) {
          this.assignShowDialogMin = false
          this.handleCheck()
          setTimeout(() => {
            this.getList(this.listQuery)
            this.$message.success('提交成功')
            document.body.scrollTop = document.documentElement.scrollTop = 0
          }, this.delay)
        } else {
          this.$message.error(data.errorMsg)
        }
      } catch (err) {
        console.log(`submit fail:${err}`)
      } finally {
        console.log(`finally`)
      }
    }

    // 批量弹窗操作
    private async confirmAssign(done: any) {
      (this.$refs.freightFormAll as any).validate(async(valid: boolean) => {
        if (valid) {
          await this.saveData1()
          done()
        }
      })
    }
    @lock
    async saveData1() {
      try {
        let moneysArr: any = []
        let wayBillAmountIdsArr: any = []
        let noCheck: any = []
        this.freightFormAll.lists.forEach((i: any) => {
          if (i.check) {
            i.list.forEach((element: any) => {
              moneysArr.push(element.preMoney)
              wayBillAmountIdsArr.push(element.wayBillAmountId)
            })
          } else {
            i.list.forEach((element: any) => {
              noCheck.push(element.wayBillAmountId)
            })
          }
        })
        if (noCheck.length) {
          // 批量未上报
          const { data } = await NoCarBatch(noCheck, this.remarkAll)
          if (data.success) {
            if (!wayBillAmountIdsArr.length) {
              this.handleCheck()
              this.assignShowDialog = false
              setTimeout(() => {
                this.getList(this.listQuery)
                this.$message.success('提交成功')
                document.body.scrollTop = document.documentElement.scrollTop = 0
              }, this.delay)
            }
            this.assignShowDialog = false
          } else {
            this.$message.error(data.errorMsg)
          }
        }
        if (wayBillAmountIdsArr.length) {
          // 上报出车金额
          const { data } = await ReportMoneyBatch({
            moneys: moneysArr,
            wayBillAmountIds: wayBillAmountIdsArr
          }, this.remarkAll)
          if (data.success) {
            this.handleCheck()
            this.assignShowDialog = false
            setTimeout(() => {
              this.getList(this.listQuery)
              this.$message.success('提交成功')
              document.body.scrollTop = document.documentElement.scrollTop = 0
            }, this.delay)
          } else {
            this.$message.error(data.errorMsg)
          }
        }
      } catch (err) {
        console.log(`submit fail:${err}`)
      } finally {
        console.log(`finally`)
      }
    }

    // 全部未出车
    private confirmAssignOther(done: any) {
      let noCheck: any = []
      this.freightFormAll.lists.forEach((i: any) => {
        i.list.forEach((element: any) => {
          noCheck.push(element.wayBillAmountId)
        })
      })
      this.$alert('确定全部' + this.freightFormAll.lists.length + '个出车，全部未出车！', '提示', {
        confirmButtonText: '确定',
        callback: async action => {
          if (action === 'confirm') {
            const { data } = await NoCarBatch(noCheck, this.remarkAll) // 批量未上报
            if (data.success) {
              this.assignShowDialogMin = false
              this.handleCheck()
              setTimeout(() => {
                this.getList(this.listQuery)
                this.$message.success('已成功操作全部未出车')
                document.body.scrollTop = document.documentElement.scrollTop = 0
              }, this.delay)
              done()
            } else {
              this.$message.error(data.errorMsg)
            }
          }
        }
      })
    }

    // 未出车
    private async confirmAssignOtherMin(done: any) {
      let wayBillAmountIdsArr: any = []
      this.freightForm.list.forEach((i: any) => {
        wayBillAmountIdsArr.push(i.wayBillAmountId)
      })
      const { data } = await NoCarBatch(wayBillAmountIdsArr, this.freightForm.remark) // 批量未上报
      if (data.success) {
        this.assignShowDialogMin = false
        this.handleCheck()
        setTimeout(() => {
          this.getList(this.listQuery)
          this.$message.success('已成功操作未出车')
          document.body.scrollTop = document.documentElement.scrollTop = 0
        }, this.delay)
        done()
      } else {
        this.$message.error(data.errorMsg)
      }
    }

    // 弹窗表格选中
    // private handleSelectionDialog(val: any) {
    //   this.saleId = val
    // }

    private async getFloowData(id: any, type: any) {
      this.floowData = []
      this.floowLoading = true
      // 获取出车详情运费列表
      const { data } = await freightTripMoney({ wayBillId: id })
      if (data.success) {
        let dataList: any = []
        data.data.forEach((element: any) => {
          if (element.reportedType === type) {
            dataList.push(element)
          }
        })
        this.floowLoading = false
        this.floowData = dataList
      } else {
        this.$message.error(data.errorMsg)
      }
    }

    // table index
    private indexMethod(type: string) {
      let page: number, limit: number
      if (type === 'listQuery') {
        ({ page, limit } = this.listQuery)
      } else if (type === 'dialogListQuery') {
        ({ page, limit } = this.listQuery)
      }
      return (index: number) => {
        return index + 1 + (page - 1) * limit
      }
    }

    // 获得本周的开始日期
    private getWednesdayDate(times: any) {
      let now = new Date() // 当前日期
      let nowDayOfWeek = now.getDay() // 今天本周的第几天
      let nowDay = now.getDate() // 当前日
      let nowMonth = now.getMonth() // 当前月
      let nowYear = now.getFullYear() // 当前年
      nowYear += (nowYear < 2000) ? 1900 : 0
      return this.formatDate(new Date(nowYear, nowMonth, nowDay + 10 - nowDayOfWeek))
    }

    // 格式化日期：yyyy-MM-dd
    private formatDate(date: any) {
      var myyear = date.getFullYear()
      var mymonth = date.getMonth() + 1
      var myweekday = date.getDate()

      if (mymonth < 10) {
        mymonth = '0' + mymonth
      }
      if (myweekday < 10) {
        myweekday = '0' + myweekday
      }
      return (myyear + '-' + mymonth + '-' + myweekday)
    }
    // 截取备注
    // private splice(value: any) {
    //   return value.slice(0, 16)
    // }
    private init() {
      let wayBillId = this.$route.query.wayBillId
      if (wayBillId) this.listQuery.wayBillId = wayBillId
      this.fetchData()
    }
    get shippingState() {
      return this.$store.state.app.states
    }
    @Watch('shippingState', { deep: true })
    private onRouteChange() {
      this.init()
    }
    // 生命周期
    created() {
      this.init()
    }

    activated() {
      this.init()
      this.$nextTick(() => {
        ((this.$refs['multipleTable']) as any).doLayout()
      })
    }
}
</script>

<style lang="scss">
.FreightList {
  padding: 15px;
  // padding-bottom: 0;
  box-sizing: border-box;
  .addNoFreight{
    margin-top: -15px;
    margin-bottom: 10px;
    margin-left: 10px;
    color: #FF5D5D;
    span{
      color: #FF5D5D;
    }
  }
  .btn-item {
    background: #649cee;
    border-radius: 4px;
    border-radius: 4px;
    border: none;
    margin: 0 10px;
  }
  .btn-item-filtrate {
    background: #ffa000;
    border-radius: 4px;
    border-radius: 4px;
    border: none;
  }
  .table_box {
    // height: calc(100vh - 225px) !important;
    background: #ffffff;
    // border: 1px solid #dfe6ec;
    box-shadow: 4px 4px 10px 0 rgba(218, 218, 218, 0.5);
    overflow: hidden;
    transform: translateZ(0);
    .table_center {
      // height: calc(100vh - 360px) !important;
      padding: 15px 30px 0;
      box-sizing: border-box;
      background: #ffffff;
      overflow-y: auto;
    }
  }
  .edit-input {
    padding-right: 100px;
  }
  .cancel-btn {
    position: absolute;
    right: 15px;
    top: 10px;
  }
  .pagination-container {
    background: #fff;
  }
  .freightSelfDialog{
    padding-bottom: 15px;
    border-bottom: 1px solid #eeeeee;
    box-sizing: border-box;
  }
  .slot-info{
    color:#FF5D5D;
    span{
      margin-right: 5px;
    }
  }
  .table-title{
    margin-top: 15px;
    line-height: 30px;
    margin-left: 30px;
    color: #000;
    font-size: 14px;
    span{
      color: #649cee;
      cursor:pointer;
    }
  }
}
</style>

<style lang="scss" scoped>
.FreightList-m {
  padding-bottom: 0;
  box-sizing: border-box;
  .btn-item-m {
    background: #649cee;
    border-radius: 4px;
    border-radius: 4px;
    border: none;
    margin: 0 10px;
  }
  .btn-item-filtrate-m {
    background: #ffa000;
    border-radius: 4px;
    border-radius: 4px;
    border: none;
  }
  .table_box {
    // height: calc(100vh - 183px) !important;
    background: #ffffff;
    // border: 1px solid #dfe6ec;
    box-shadow: 4px 4px 10px 0 rgba(218, 218, 218, 0.5);
    overflow: hidden;
    transform: translateZ(0);
    .table_center {
      // height: calc(100vh - 300px) !important;
      padding-bottom: 0;
      box-sizing: border-box;
      background: #ffffff;
      overflow-y: scroll;
    }
  }
  .edit-input {
    padding-right: 100px;
  }
  .cancel-btn {
    position: absolute;
    right: 15px;
    top: 10px;
  }
  .pagination-container {
    background: #f8f9fa;
  }
  .el-table th.gutter {
    display: table-cell !important
  }
}
</style>

<style lang="scss" scope>
// .el-collapse-item__content {
//   padding-bottom: 0;
// }

.el-form-item__content{
  font-size: 13px;
}

.el-form-item__label {
  color: #999999;
}

.redio-label{
  .el-radio__label{
    display: none;
  }
}

.el-dialog__body{
  max-height: 60vh;
  overflow: auto;
}
</style>
